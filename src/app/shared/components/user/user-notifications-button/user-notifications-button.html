<div class="relative">
  <p-button
    icon="pi pi-bell"
    text
    rounded
    (onClick)="togglePopover($event)"
    [pTooltip]="'notifications.title' | translate"
  >
    @if (hasUnreadNotifications()) {
    <span class="badge">{{ unreadCount() > 99 ? '99+' : unreadCount() }}</span>
    }
  </p-button>

  <p-popover
    #popover
    (onShow)="onPopoverShow()"
    (onHide)="onPopoverHide()"
    styleClass="notifications-popover"
  >
    <ng-template #content>
      <div class="flex flex-col">
        <!-- Header -->
        <div class="flex items-center justify-between p-3 border-b border-surface-border">
          <h3 class="text-lg font-semibold m-0">
            {{ 'notifications.title' | translate }}
          </h3>
          @if (hasNotifications() && hasUnreadNotifications()) {
          <p-button
            label="{{ 'notifications.markAllRead' | translate }}"
            text
            size="small"
            (onClick)="markAllAsRead()"
          />
          }
        </div>

        <!-- Notifications List -->
        <div
          class="notifications-list"
          infiniteScroll
          [infiniteScrollDistance]="2"
          [infiniteScrollThrottle]="300"
          [scrollWindow]="false"
          (scrolled)="onScroll()"
        >
          @if (hasNotifications()) {
          <div class="flex flex-col">
            @for (notification of paginatedNotifications.items(); track notification.id) {
            <div
              class="notification-item"
              [class.unread]="!notification.isRead"
              (click)="onNotificationClick(notification)"
              (keyup.enter)="onNotificationClick(notification)"
              (keyup.space)="onNotificationClick(notification)"
              tabindex="0"
              role="button"
            >
              <div class="flex items-start gap-2">
                <div class="flex-1">
                  <div class="notification-title">
                    {{ notification.title }}
                  </div>
                  <div class="notification-message">
                    {{ notification.message }}
                  </div>
                  <div class="notification-time">
                    {{ formatDate(notification.createdAt) }}
                  </div>
                </div>
                @if (!notification.isRead) {
                <div class="w-2 h-2 rounded-full bg-primary mt-2"></div>
                }
              </div>
            </div>
            }
          </div>
          } @else if (paginatedNotifications.loading()) {
          <div class="p-4 text-center text-surface-500">
            {{ 'common.loading' | translate }}
          </div>
          } @else {
          <div class="p-4 text-center text-surface-500">
            {{ 'notifications.noNotifications' | translate }}
          </div>
          } @if (paginatedNotifications.loading() && hasNotifications()) {
          <div class="p-2 text-center text-surface-500 text-sm">
            {{ 'common.loading' | translate }}
          </div>
          }
        </div>
      </div>
    </ng-template>
  </p-popover>
</div>
